<head>

    <link rel="stylesheet" href="//ssl.gstatic.com/docs/script/css/add-ons.css" />
    <script src="//ajax.googleapis.com/ajax/libs/jquery/1.10.2/jquery.min.js"></script>

</head>

<div>
    <!-- header -->
    <div id="importOntology" style="position:fixed;">


        <div class="ontologyDropdown" style="padding-bottom:2px;">
            <? var source = getBioPortalOntologies();?>
            <select style="width:280px;" class="ontologySelect">
                <option value="" selected>Search all ontologies</option>
                <?
                 
              //var iri = "@id";
              for(var i=0; i < source.length; i++){
               if(source[i] != null){ ?>
                <option value="<?=source[i].acronym;?>"><?=source[i].name; ?> (<?=source[i].acronym; ?>)</option>

                <?}
         }?>
            </select>
        </div>

        <div>
            <table>
                <tr>
                    <td style="width:100%">
                        <input id="search-box" name="query" placeholder="Enter a search term..." class="queryString" style="height:20px;width:95%;"/>
                    </td>
                    <td>
                        <button id="search-button" class="action" onclick="doBioPortalSearch($('.queryString').val(), $('.ontologySelect').val());">Search</button>
                    </td>
                </tr>
            </table>

        </div>

 
        <hr/>

    </div>

    <div id="spinner" style="top:120px;position:fixed;display:block;height:30px;display:none;">
      <div class="loading" style="margin-right:-10px;float:left;">
        <img style="height:20px;width:20px;" src="https://5079980847011989849-a-1802744773732722657-s-sites.googlegroups.com/site/scriptsexamples/ProgressSpinner.gif"/>
                Searching, please wait...
      </div>
    </div>   
        
    <!-- search results -->
    <div id="search"  style="top:100px;position:fixed;display:block;height:100%;width:280px;overflow-y:auto; overflow-x:auto;">
        <div class="searchresults" style="margin-bottom:200px">
        </div>
    </div>


    <div id="welcome" style="top:150px;position:relative;">

        <div align="center">
        <p style="font-weight: bold;">Welcome to the Ontology Search tool!</p>
        <p>Here you can search across all ontologies in BioPortal, or select a specific ontology to search. From the search results you can insert term labels directly into selected cells or create a data validation using subclasses or descendnants of a given term</p>
        <p>
            <span style="font-size:smaller;color:gray;">Webulous - developed by EMBL-EBI</span><br/>
            <span style="font-size:smaller;color:gray;">Powered by NCBO BioPortal</span>
        </div>

    </div>

</div>

<script>

    $( document ).ready(function() {
        $("#search-box").keyup(function(event){
            if(event.keyCode == 13){
                $("#search-button").click();
            }
        });
    });

    //$(window).on('load resize', function(){
    //    $('.searchdiv').height($(this).height());
    //});

    function renderSearchResults(json) {
        $(".searchresults").html('');

        if (json.collection.length > 0) {

            for(var i=0; i<json.collection.length; i++){
                var record = json.collection[i];
                var label = record.prefLabel;
                var ontologyUri = record.links.ontology;
                var n = ontologyUri.lastIndexOf('/');
                var ontology = ontologyUri.substring(n + 1);

                var definition = "";
                if (record.definition != null) {
                    definition = record.definition[0];
                    if (definition.length > 150) {
                        definition = definition.substr(0, 150) + 'â€¦';
                    }
                }

                var iri = record["@id"];
                var bp_iri = record.links.ui;
                var wbaction = "wb-action-" + i;

                var buttondiv =
                        $("<div align=\"center\" class=\"" + wbaction + "\" style=\"z-index:10;position:relative;height:100%;width:100%;display:none;bottom:0;\">" +
                        //"<input class=\"action\" style=\"height: 20px;line-height: 20px;min-width: 22px;font-size: 10px;\" type=\"button\" value=\"Add\" onclick=\"setRestriction(" + i + ")\"> " +
                        "<input class=\"action\" style=\"height: 20px;line-height: 20px;min-width: 22px;font-size: 10px;\" type=\"button\" value=\"Subclasses\" onclick=\"setRestrictionsFromBP(" + i + ", 'children')\"> " +
                        "<input class=\"action\" style=\"height: 20px;line-height: 20px;min-width: 22px;font-size: 10px;\" type=\"button\" value=\"Descendants\" onclick=\"setRestrictionsFromBP(" + i + ", 'descendants')\"></div>");
                var div = $("<div style=\"border: 1px solid transparent;position:relative;margin:4px;padding:4px;\" class=\"action-" + i + "\">");

                div.on ('mouseover', function() {
                    $(this).css("border", "solid 1px #d9d9d9");
                    var id = "wb-" + $(this).attr('class');
                    $("." + id).show();
                });
                div.on ('mouseout', function() {
                    $(this).css("border", "solid 1px transparent");
                    var id = "wb-" + $(this).attr('class');
                    $("." + id).hide();
                });

                div.append("<div><a  target=\"_blank\" style=\"font-size: 90%;text-decoration: underline;font-weight: bold;\" href=\"" + bp_iri + "\">"  + label + " (" + ontology + ")</a> <a style=\"font-size: smaller;border-bottom:1px dotted #999;\" onclick=\"paste('" + label + "')\" href=\"#\">insert label</a></div>");
                div.append("<div style=\"font-size: 70%;color:green;\">" + iri + "</div>");
                div.append("<div style=\"font-size: 85%;\">" + definition + "</div>");
                div.append("<input type=\"hidden\" class=\"term-iri-" + i + "\" value=\"" + iri + "\"/>");
                div.append("<input type=\"hidden\" class=\"term-ontology-" + i + "\" value=\"" + ontology + "\"/>");
                div.append("<input type=\"hidden\" class=\"term-label-" + i + "\" value=\"" + label + "\"/>");
                div.append(buttondiv);

                $(".searchresults").append(div);
            }
        }
        else {
            $("div.searchresults").html("<p>No results</p>");
        }
        hideSpinner();

    }

    function doBioPortalSearch(query, ontology) {
        showSpinner();
        google.script.run.withFailureHandler(onFailure).withSuccessHandler(renderSearchResults).searchBioportal(query, ontology);
    }

    function paste(label) {
        google.script.run.setCellValue(label);
    }

    function setRestrictionsFromBP(id, type) {
        //showSpinner();
        google.script.run.showToast("Loading validations form bioportal in the background", "", 5);
        var ontology = $(".term-ontology-" + id).val();
        var term = $(".term-label-" + id).val();
        var iri = $(".term-iri-" + id ).val();
        google.script.run.withFailureHandler(onFailure).withSuccessHandler(onSuccess).getRestrictionValuesFromBP(ontology, iri, term, type);
    }

    function setRestriction(id){
        showSpinner();
        var ontology = $('.ontologySelect').val();
        var term = $(".term-label-" + id).val();
        var iri = $(".term-iri-" + id ).val();
        google.script.run.withFailureHandler(onFailure).withSuccessHandler(onSuccess).getRestrictionValues(ontology, iri, term);
    }

    function onFailure() {
        hideSpinner();
    }

    function onSuccess(msg){
        google.script.run.showToast(msg.message, "", 4);
        hideSpinner();
    }

    function showSpinner() {
        $(".searchresults").html('');
        $("#welcome").hide();
        $("#spinner").show();
  //      $(".loading").css("visibility", "visible");
    }

    function hideSpinner() {
        $("#spinner").hide();
//        $(".loading").css("visibility", "hidden");
    }

</script>

