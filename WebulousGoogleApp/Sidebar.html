<link rel="stylesheet" href="https://ssl.gstatic.com/docs/script/css/add-ons.css" />
<link rel="stylesheet" href="http://bioportal.bioontology.org/widgets/minified/jquery.ncbo.tree.min.css" />

<script src="//ajax.googleapis.com/ajax/libs/jquery/1.10.2/jquery.min.js"></script>
<script src="http://bioportal.bioontology.org/widgets/minified/jquery.ncbo.tree.min.js"></script>


<div style="margin-left: 10px; margin-top: 20px" id="dataRestriction">
    <h3>Ontology term restriction</h3>
    <div id="importOntology">
        <b>Use restriction ontology</b> <br>
        <div class="ontologyDropdown">
            <? var source = SpreadsheetApp.getActiveSpreadsheet().getSheetByName("SourceData");
         var max = source.getLastRow();
         var data = source.getRange(1, 1, max, 2)?>
            <select class="ontologySelect">
                <?  for(var i=0; i < max; i++){
               if(data.getCell(i+1, 1).getValue() != ""){ ?>
                <option value="<?=data.getCell(i+1, 1).getValue();?>"><?=data.getCell(i+1, 2).getValue();?> (<?=data.getCell(i+1, 1).getValue();?>)</option>

                <?}
         }?>
            </select>
        </div>

    </div>
    <br>
    <br>
    <br>
    <br>
    <div id="hierarchy">
        <b>Restrict selection to</b><br>
        <input class="restrictionParent" type="text" placeholder="Enter ontoloy term"><br><br>
        <div align="center">
            <input type="button" value="View hierarchy in Bioportal" onclick="openBP()">
        </div>
        <br>
        <div align="center" class="bpLink"> </div>
    </div>
    <br>
    <br>
    <b>Types of allowed values</b> <br>
    <div id="allowedValues">
        <!--     <input type="radio" name="restrictionType" value="freeText" checked/>Free text<br> -->
        <input type="radio" class="restrictionType" name="restrictionType" value="children" />Direct subclasses<br>
        <input type="radio" class="restrictionType" name="restrictionType" value="descendants" />Subclasses<br>
        <!--     <input type="radio" name="restrictionType" value="directInstance" />Direct instances<br>
             <input type="radio" name="restrictionType" value="instance" />Instances<br> -->
    </div>
    <br>
    <br>
    <div align="center">
        <input type="button" value="Apply"  onclick="setRestrictions()"/>
    </div>

    <br>
    <br>
    <div align="center">
        <input type="button" value="Remove restriction"  onclick="google.script.run.removeRestriction()"/>
    </div>

    <br>
    <br>
    <div class="status"> </div>
</div>

<script>
    function openBP(){

        var main = "http://bioportal.bioontology.org/ontologies/";
        var tail = "?p=classes&conceptid=root";
        var url = main + $('.ontologySelect').val() + tail;
        var prompt = "<a href=\"" + url + "\"id=\"bp_link\" class=\"bp_link\" target=\"_blank\">Click here to go to Bioportal</a>";

        $("div.bpLink").html(prompt);
    }

    function setRestrictions(){

        var ontology = $('.ontologySelect').val();
        var term = $(".restrictionParent").val();
        var restrict = $('input[name="restrictionType"]:checked').val();
        google.script.run.withSuccessHandler(onSuccess).getRestrictionValues(ontology, term, restrict);
        $("div.status").html("Restriction submitted. If " + term + " has lots of " + restrict + ", this could take a few moments.");
    }

    function onSuccess(){
        $("div.status").html("");
    }
</script>
